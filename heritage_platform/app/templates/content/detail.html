{% extends 'base.html' %}

{% block title %}{{ content.title }} - 体育非遗数字展示平台{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">首页</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('content.list') }}">内容专区</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('content.list', heritage_id=content.heritage_id) }}">{{ content.heritage.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ content.title }}</li>
        </ol>
    </nav>
    
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">{{ content.title }}</h1>
                {% if current_user.is_authenticated and (current_user.id == content.user_id or current_user.is_admin) %}
                <div>
                    <a href="{{ url_for('content.edit', id=content.id) }}" class="btn btn-sm btn-outline-primary me-2">
                        <i class="fas fa-edit me-1"></i>编辑
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteContentModal">
                        <i class="fas fa-trash-alt me-1"></i>删除
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="content-cover-wrapper">
        {% if content.cover_image %}
        <div class="content-cover-image fade-in">
            <img src="{{ url_for('static', filename=content.cover_image) }}" 
                 alt="{{ content.title }}的封面图"
                 class="content-cover cover-mode"
                 id="coverImage">
            <div class="cover-controls">
                <button type="button" class="btn btn-light btn-sm active" onclick="switchImageMode('cover')" id="coverBtn">
                    <i class="fas fa-crop"></i> 填充模式
                </button>
                <button type="button" class="btn btn-light btn-sm" onclick="switchImageMode('fit')" id="fitBtn">
                    <i class="fas fa-expand"></i> 完整模式
                </button>
            </div>
        </div>
        {% endif %}
    </div>
        
        <div class="card-body content-body">
            <!-- 装饰性分隔元素 -->
            <div class="content-divider"></div>
            <div class="content-meta slide-in-left">
                <div class="content-author">
                    <div class="content-avatar">
                        {% if content.author.avatar %}
                        <img src="{{ content.author.avatar }}" class="avatar-sm" alt="{{ content.author.username }}">
                        {% else %}
                        <div class="avatar-sm avatar-text">
                            {{ content.author.username[0] }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="content-info">
                        <div class="author-name">{{ content.author.username }}</div>
                        <div class="content-time">{{ content.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                </div>
                <div>
                    <span class="badge bg-primary">
                        {% if content.content_type == 'article' %}文章
                        {% elif content.content_type == 'image' %}图片
                        {% elif content.content_type == 'video' %}视频
                        {% elif content.content_type == 'multimedia' %}多媒体
                        {% endif %}
                    </span>
                    <span class="badge bg-secondary">{{ content.heritage.name }}</span>
                </div>
            </div>
            
            <!-- 优化后的内容显示区域 -->
            <div class="content-display fade-in">
                {% if content.content_type == 'article' %}
                    <div class="article-content markdown-body">
                        {{ content.text_content|markdown|safe }}
                    </div>
{% elif content.content_type == 'image' %}
    <div class="text-center">
        {% if content.file_path %}
            <img src="{{ url_for('static', filename=content.file_path) }}" class="img-fluid mb-3" alt="{{ content.title }}">
        {% endif %}
        {% if content.images.count() > 0 %}
            <div class="row g-3">
                {% for image in content.images %}
                <div class="col-12 col-md-6">
                    <img src="{{ url_for('static', filename=image.file_path) }}" class="img-fluid" alt="{{ image.caption or content.title }}">
                    {% if image.caption %}
                    <p class="mt-2 text-muted">{{ image.caption }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% endif %}
        {% if not content.file_path and content.images.count() == 0 %}
            <div class="alert alert-warning">
                没有可显示的图片内容
            </div>
        {% endif %}
    </div>
                {% elif content.content_type == 'video' and content.file_path %}
                    <div class="text-center">
                        <video controls class="img-fluid">
                            <source src="{{ url_for('static', filename=content.file_path) }}" type="video/mp4">
                            您的浏览器不支持视频播放
                        </video>
                    </div>
                {% elif content.content_type == 'multimedia' and content.rich_content %}
                    <div class="multimedia-content">
                        {{ content.rich_content|safe }}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        没有可显示的内容
                    </div>
                {% endif %}
            </div>
            
            <!-- 优化后的互动工具栏 -->
            <div class="content-actions slide-in-right">
                <div class="content-stats">
                    <span class="stat-item"><i class="far fa-eye"></i> {{ content.views }}</span>
                    <span class="stat-item"><i class="far fa-comment"></i> {{ content.comments.count() }}</span>
                    <span class="stat-item"><i class="far fa-heart"></i> {{ content.likes.count() }}</span>
                </div>
                <div class="content-buttons">
                    {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('content.like', id=content.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-sm {% if has_liked %}btn-danger{% else %}btn-outline-danger{% endif %}">
                            <i class="{% if has_liked %}fas{% else %}far{% endif %} fa-heart me-1"></i> 
                            {% if has_liked %}已点赞{% else %}点赞{% endif %}
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('content.favorite', id=content.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-sm {% if has_favorited %}btn-warning{% else %}btn-outline-warning{% endif %}">
                            <i class="{% if has_favorited %}fas{% else %}far{% endif %} fa-star me-1"></i> 
                            {% if has_favorited %}已收藏{% else %}收藏{% endif %}
                        </button>
                    </form>
                    {% else %}
                    <a href="{{ url_for('auth.login', next=request.path) }}" class="btn btn-sm btn-outline-primary">登录后互动</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- 评论区 -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h4 class="mb-0">评论区</h4>
            <span>共 {{ pagination.total if pagination else 0 }} 条评论</span>
        </div>
        <div class="card-body">
            {% if current_user.is_authenticated %}
            <div class="mb-4">
                <form method="POST" action="{{ url_for('content.detail', id=content.id) }}">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        {{ form.text.label(class="form-label") }}
                        {{ form.text(class="form-control", rows=3) }}
                        {% if form.text.errors %}
                            <div class="text-danger">
                                {% for error in form.text.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
            {% else %}
            <div class="alert alert-info">
                请<a href="{{ url_for('auth.login', next=request.path) }}">登录</a>后发表评论
            </div>
            {% endif %}
            
            <!-- 评论列表 -->
            {% if comments %}
                <div class="list-group">
                    {% for comment in comments %}
                    <div class="list-group-item border-0 border-bottom">
                        <div class="d-flex">
                            <div class="flex-shrink-0 me-3">
                                {% if comment.author.avatar %}
                                <img src="{{ comment.author.avatar }}" class="avatar-sm rounded-circle" alt="{{ comment.author.username }}">
                                {% else %}
                                <div class="avatar-sm d-flex align-items-center justify-content-center bg-secondary text-white rounded-circle">
                                    {{ comment.author.username[0] }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ comment.author.username }}</strong>
                                        <small class="text-muted ms-2">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div>
                                        {% if current_user.is_authenticated and (current_user.id == comment.user_id or current_user.is_admin) %}
                                        <button class="btn btn-sm btn-link text-danger">删除</button>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="mb-0 mt-1">{{ comment.text }}</p>

                                <!-- 回复按钮 -->
                                {% if current_user.is_authenticated %}
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary reply-btn" data-comment-id="{{ comment.id }}">
                                        <i class="fas fa-reply"></i> 回复
                                    </button>
                                </div>
                                {% endif %}

                                <!-- 嵌套回复表单 -->
                                {% if current_user.is_authenticated %}
                                <div class="reply-form mt-3" id="reply-form-{{ comment.id }}" style="display: none;">
                                    <form method="POST" action="{{ url_for('content.reply_comment', content_id=content.id, comment_id=comment.id) }}">
                                        {{ form.hidden_tag() }}
                                        <div class="mb-3">
                                            {{ form.text.label(class="form-label") }}
                                            {{ form.text(class="form-control", rows=3) }}
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm">提交回复</button>
                                        <button type="button" class="btn btn-secondary btn-sm cancel-reply-btn" data-comment-id="{{ comment.id }}">取消</button>
                                    </form>
                                </div>
                                {% endif %}

                                <!-- 嵌套回复列表 -->
                                {% if comment.replies.count() > 0 %}
                                <div class="replies mt-3 ms-4 border-start ps-3">
                                    {% for reply in comment.replies %}
                                    <div class="reply mb-3">
                                        <div class="d-flex align-items-center small text-muted mb-1">
                                            <i class="fas fa-user me-1"></i> {{ reply.author.username }}
                                            {% if reply.reply_to_user %}
                                            <i class="fas fa-reply mx-1"></i>
                                            {{ reply.reply_to_user.username }}
                                            {% endif %}
                                            <span class="mx-2">|</span>
                                            <i class="fas fa-clock me-1"></i> {{ reply.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        </div>
                                        <div class="reply-content">
                                            {{ reply.text }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- 评论分页 -->
                {% if pagination and pagination.pages > 1 %}
                <nav class="mt-4" aria-label="评论分页">
                    <ul class="pagination justify-content-center">
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('content.detail', id=content.id, page=pagination.prev_num) }}">上一页</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">上一页</a>
                        </li>
                        {% endif %}
                        
                        {% for p in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                            {% if p %}
                                {% if p == pagination.page %}
                                <li class="page-item active" aria-current="page">
                                    <a class="page-link" href="#">{{ p }}</a>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('content.detail', id=content.id, page=p) }}">{{ p }}</a>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">...</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('content.detail', id=content.id, page=pagination.next_num) }}">下一页</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">下一页</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="alert alert-light text-center">
                    暂无评论，发表第一条评论吧！
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 相关内容推荐 -->
    {% if related_contents %}
    <h4 class="mb-3">相关内容推荐</h4>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
        {% for related in related_contents %}
        <div class="col">
            <div class="card h-100">
                <img src="{% if related.cover_image %}{{ url_for('static', filename=related.cover_image) }}{% else %}{{ url_for('static', filename='img/default-content.jpg') }}{% endif %}" 
                     class="card-img-top" 
                     style="height: 150px; object-fit: cover;"
                     alt="{{ related.title }}">
                <div class="card-body">
                    <h5 class="card-title">{{ related.title }}</h5>
                    <p class="card-text"><small class="text-muted">{{ related.author.username }} · {{ related.created_at.strftime('%Y-%m-%d') }}</small></p>
                    {% if related.heritage %}
                    <span class="badge bg-secondary">{{ related.heritage.name }}</span>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-top-0">
                    <a href="{{ url_for('content.detail', id=related.id) }}" class="btn btn-sm btn-outline-primary">查看详情</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- 删除确认模态框 -->
{% if current_user.is_authenticated and (current_user.id == content.user_id or current_user.is_admin) %}
<div class="modal fade" id="deleteContentModal" tabindex="-1" aria-labelledby="deleteContentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteContentModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除内容 "{{ content.title }}" 吗？</p>
                <p class="text-danger"><small>此操作将永久删除该内容，包括所有评论、点赞和收藏。</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form action="{{ url_for('content.delete', id=content.id) }}" method="POST" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 图片显示模式切换
    window.switchImageMode = function(mode) {
        const image = document.getElementById('coverImage');
        const coverBtn = document.getElementById('coverBtn');
        const fitBtn = document.getElementById('fitBtn');
        
        if (mode === 'cover') {
            image.classList.remove('fit-mode');
            image.classList.add('cover-mode');
            coverBtn.classList.add('active');
            fitBtn.classList.remove('active');
        } else {
            image.classList.remove('cover-mode');
            image.classList.add('fit-mode');
            fitBtn.classList.add('active');
            coverBtn.classList.remove('active');
        }
    };

    // 回复按钮点击事件
    const replyButtons = document.querySelectorAll('.reply-btn');
    replyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
        });
    });

    // 取消回复按钮点击事件
    const cancelButtons = document.querySelectorAll('.cancel-reply-btn');
    cancelButtons.forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            document.getElementById(`reply-form-${commentId}`).style.display = 'none';
        });
    });
});
</script>
{% endblock %}

{% block styles %}
<style>
.markdown-body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    font-size: 16px;
    line-height: 1.6;
    word-wrap: break-word;
}

.markdown-body h1, .markdown-body h2, .markdown-body h3, 
.markdown-body h4, .markdown-body h5, .markdown-body h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}

.markdown-body h1 { font-size: 2em; }
.markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
.markdown-body h3 { font-size: 1.25em; }
.markdown-body h4 { font-size: 1em; }

.markdown-body code {
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: rgba(27, 31, 35, 0.05);
    border-radius: 3px;
}

.markdown-body pre {
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 3px;
    margin-bottom: 16px;
}

.markdown-body pre > code {
    padding: 0;
    margin: 0;
    background-color: transparent;
    border: 0;
}

.markdown-body blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0 0 16px 0;
}

.markdown-body table {
    display: block;
    width: 100%;
    overflow: auto;
    border-spacing: 0;
    border-collapse: collapse;
    margin-bottom: 16px;
}

.markdown-body table th, .markdown-body table td {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}

.markdown-body table tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}

.markdown-body table tr:nth-child(2n) {
    background-color: #f6f8fa;
}

.markdown-body img {
    max-width: 100%;
    box-sizing: content-box;
}

.markdown-body hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}

.markdown-body ul, .markdown-body ol {
    padding-left: 2em;
    margin-bottom: 16px;
}

.markdown-body li {
    margin-bottom: 0.25em;
}

.markdown-body p {
    margin-top: 0;
    margin-bottom: 16px;
}
</style>
{% endblock %}
